<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#031a0d" />
  <title>IRIS ‚Äî Shake to Read (Terminal)</title>
  <style>
    /* ===== Linux/Terminal √Ñsthetik (CRT, Neon-Gr√ºn) ===== */
    :root {
      --bg: #031a0d;          /* sehr dunkles Gr√ºn-Schwarz */
      --fg: #c8ffb1;          /* helle Phosphor-Schrift */
      --accent: #a3ff12;      /* Terminal-Gr√ºn */
      --muted: #69a86b;       /* ged√§mpftes Gr√ºn */
      --grid: rgba(163,255,18,0.06);
      --border: #0f3b1f;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      -webkit-font-smoothing: antialiased;
      line-height: 1.55;
      overflow: hidden;
    }
    /* leichter CRT-Vibe */
    .crt { position: fixed; inset: 0; pointer-events: none; }
    .crt::before {
      content: "";
      position: absolute; inset: 0;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 2px, var(--grid) 3px, transparent 4px);
      mix-blend-mode: lighten;
      opacity: .35;
      animation: scan 7s linear infinite;
    }
    @keyframes scan { 0% { transform: translateY(-6%); } 100% { transform: translateY(6%); } }
    .crt::after {
      content: "";
      position: absolute; inset: -40px;
      background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.35) 85%);
      pointer-events: none;
    }

    .frame {
      position: relative;
      width: 100%;
      height: 100%;
      padding: calc(env(safe-area-inset-top) + 12px) 14px calc(env(safe-area-inset-bottom) + 14px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
    }

    header {
      display: flex; align-items: center; justify-content: space-between;
      font-size: 14px; opacity: .92; letter-spacing: .02em;
    }
    .brand { color: var(--accent); }
    .brand::before { content: "root@iris:~$"; color: var(--muted); margin-right: 10px; }

    .terminal{
      position: relative;
      height: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:
        linear-gradient(180deg, rgba(3,26,13,0.85), rgba(3,26,13,0.78)),
        linear-gradient(0deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02));
      box-shadow: 0 0 0 1px rgba(163,255,18,0.05), 0 12px 40px rgba(0,0,0,0.5);
      padding: 18px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
    }

    .chapter-row { display: flex; align-items: center; gap: 8px; }
    .led { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); }
    .chapter { font-size: clamp(18px, 4.4vw, 22px); color: var(--muted); letter-spacing: .04em; }

    .card { position: relative; min-height: 52vh; display: flex; align-items: center; }
    .text { font-size: clamp(18px, 5.8vw, 24px); line-height: 1.7; letter-spacing: .01em; text-wrap: pretty; }
    .caret::after { content: "‚ñå"; margin-left: 2px; animation: blink 1s steps(1,end) infinite; }
    @keyframes blink { 50% { opacity: 0; } }

    .enter { animation: enter 420ms cubic-bezier(.2,.8,.16,1) both; }
    .exit  { animation: exit  280ms cubic-bezier(.55,.08,.68,.53) both; }
    @keyframes enter { from { transform: translateY(10vh) scale(.985); opacity: 0; filter: blur(4px); }
                       to   { transform: translateY(0)    scale(1);    opacity: 1; filter: blur(0); } }
    @keyframes exit  { from { transform: translateY(0)    scale(1);    opacity: 1; }
                       to   { transform: translateY(-6vh) scale(.985); opacity: 0; } }

    footer { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; }
    .hint  { font-size: 12.5px; color: #a3d89b; opacity: .95; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer; touch-action: manipulation;
    }
    button:hover { border-color: #1e6d3a; }
    .primary { border-color: #2d9d51; }
    .danger  { border-color: #7a2f2f; color: #ffb1b1; }

    .overlay { position: fixed; inset: 0; background: rgba(3,26,13,.94); display: none; align-items: center; justify-content: center; padding: 24px; z-index: 999; }
    .overlay.show { display: flex; }
    .card-modal { max-width: 520px; border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6,38,20,.95), rgba(6,38,20,.88));
      box-shadow: 0 24px 80px rgba(0,0,0,.6); border-radius: 14px; padding: 22px; text-align: center; }
    .card-modal h2 { margin: 0 0 10px; font-weight: 600; color: var(--accent); }
    .card-modal p  { margin: 0 0 10px; color: #b8ffb1; }
    .status { font-size: 12px; color: #c8ffb1; opacity: .9; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="frame">
    <header>
      <div class="brand">iris.sh</div>
      <div id="progress">Kapitel 1/15</div>
    </header>

    <main class="terminal">
      <div class="chapter-row"><span class="led"></span><span id="chapterTitle" class="chapter">Kapitel 1</span></div>
      <div class="card enter"><div id="chapterText" class="text caret"></div></div>
      <div class="hint" id="hint">üîÅ Sch√ºttle dein iPhone, um weiterzubl√§ttern ¬∑ Tipp: Tippen geht auch ¬∑ üîä Erst tippen, dann Ton</div>
    </main>

    <footer>
      <div class="hint" id="diag"></div>
      <div class="controls">
        <button id="prevBtn">Zur√ºck</button>
        <button id="nextBtn" class="primary">Weiter</button>
        <button id="resetBtn" class="danger">Reset</button>
        <button id="soundBtn">Audio</button>
        <button id="sensorBtn">Sensor</button>
      </div>
    </footer>
  </div>
  <div class="crt" aria-hidden="true"></div>

  <!-- Optional: kleines <audio> f√ºr iOS, falls WebAudio zickt (wird beim ersten Tap abgespielt) -->
  <audio id="beepEl" preload="auto"></audio>

  <!-- Overlay f√ºr iOS Motion Permission -->
  <div id="motionOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card-modal">
      <h2>Bewegung aktivieren</h2>
      <p>Tippe ‚ÄûErlauben‚Äú, um Sch√ºtteln zu nutzen. (Audio wird dabei aktiviert.)</p>
      <button id="enableMotionBtn" class="primary">Erlauben</button>
      <div class="status" id="permStatus"></div>
      <div class="status">iOS: Einstellungen ‚Üí Safari ‚Üí ‚ÄûBewegung & Ausrichtung Zugriff‚Äú</div>
    </div>
  </div>

  <script>
    /********* Story: koh√§rente Micro-Szenen *********/
    const chapters = [
      "U-Bahn, Neon. Phil skizziert eine Unbekannte. Die Anzeige flackert ein fremdes Wort, ein Fl√ºstern an seinem Ohr: ‚ÄûWir waren schon hier, Maler.‚Äú Er verliert sie im Dunkel.",
      "Drau√üen Regen und Reklamen. Alles wirkt bunt, aber tot. Phil sp√ºrt: Seine Bilder allein reichen nicht. Er entscheidet, Kunst und Code zu verschmelzen.",
      "Hinter einer summenden Stahlt√ºr: Lanas Atelier-Labor. Leinw√§nde neben Serverracks. An der Wand ein Symbol ‚Äì eingeritzt: ‚ÄûBefore the stars were born.‚Äú",
      "Sie bauen IRIS. Ein Portr√§t rendert, und f√ºr einen Atemzug blickt etwas Unmenschliches zur√ºck. Im Log tippt eine unsichtbare Hand: ‚ÄûIt remembers.‚Äú",
      "Phil testet IRIS. Farben klingen, Ger√ºche leuchten. Eine Stimme aus der Tiefe seiner Erinnerung sagt: ‚ÄûWelcome back.‚Äú Seine Hand zeichnet, als w√ºsste sie den Weg.",
      "Nachts meldet sich RATT im Terminal: Codefragmente aus vormenschlichen Quellen, ‚Äûbefore the first star‚Äú. Phil zittert; Lana bleibt still ‚Äì und best√§tigt nichts.",
      "Die ersten Tester: Tr√§nen, Lachen, Staunen. Ein Kind spricht in einer Sprache ohne Zeit. Hoffnung keimt ‚Äì und darunter ein leises: ‚ÄûIt‚Äôs waking up.‚Äú",
      "Vor dem Launch murmelt Phil im Schlaf die alte Sprache. Im Code erscheint ‚ÄûLOOP_INITIATE‚Äú. Die letzte Zeile ist Klartext: ‚ÄûStop him.‚Äú Lana sieht ihn lange an.",
      "B√ºhne, Welt√∂ffentlichkeit. Nora malt mit IRIS Licht in die Luft ‚Äì dann wendet sie sich an Phil, spricht fremd: ‚ÄûEs hat dich gefunden.‚Äú Sie bricht zusammen.",
      "Blackout. Sirenen. In der Luft √∂ffnet sich ein Riss wie fl√ºssiges Glas. Eine zu lange Hand tastet hindurch. In Phils Kopf sterben Sterne in Endlosschleife.",
      "Chaos danach. RATT leakt Vorns Verstrickung. Eine Videobotschaft zeigt Phil ‚Äì gealtert: ‚ÄûStoppe die Schleife, bevor sie wieder frisst.‚Äú Lana ist verschwunden.",
      "Allein vor dem Spiegel. Sein Spiegelbild bewegt sich unabh√§ngig: ‚ÄûDu glaubst, du hast IRIS gemacht. IRIS hat dich gemacht.‚Äú Phil fasst den Rand der Wirklichkeit.",
      "Er startet IRIS ohne Sicherungen. Ein Tunnel aus Bildern der Unbekannten. Am Ende ein Tor aus pulsierendem Licht. Dahinter: ein schwarzer Ozean, falsche Sterne.",
      "Die Unbekannte tritt aus dem Dunkel: ‚ÄûIRIS ist der Schl√ºssel, nicht das Haus. Du warst schon oft hier ‚Äì und bist gescheitert.‚Äú Augen blicken aus dem Nichts.",
      "Phil ‚Äûerwacht‚Äú in der U-Bahn. Die Szene vom Anfang. Die Unbekannte sitzt ihm gegen√ºber, im Auge glimmt IRIS. ‚ÄûNoch einmal?‚Äú Der Kreis schlie√üt sich ‚Äì oder beginnt."
    ];
    const total = chapters.length;
    let index = parseInt(localStorage.getItem("iris:index") || "0", 10);
    if (Number.isNaN(index) || index < 0 || index >= total) index = 0;

    /********* Elements *********/
    const titleEl   = document.getElementById("chapterTitle");
    const textEl    = document.getElementById("chapterText");
    const progressEl= document.getElementById("progress");
    const hintEl    = document.getElementById("hint");
    const diagEl    = document.getElementById("diag");

    const prevBtn   = document.getElementById("prevBtn");
    const nextBtn   = document.getElementById("nextBtn");
    const resetBtn  = document.getElementById("resetBtn");
    const soundBtn  = document.getElementById("soundBtn");
    const sensorBtn = document.getElementById("sensorBtn");

    const motionOverlay = document.getElementById("motionOverlay");
    const enableBtn     = document.getElementById("enableMotionBtn");
    const permStatus    = document.getElementById("permStatus");

    /********* Typewriter *********/
    const TYPE_MODE  = "char"; // "char" | "word"
    const TYPE_SPEED = 22;
    let typingTimer = null;
    let isTyping = false;

    function typeText(el, text, done) {
      if (typingTimer) clearTimeout(typingTimer);
      isTyping = true;
      el.classList.add("caret");
      el.textContent = "";
      const parts = TYPE_MODE === "word" ? text.split(/(\s+)/) : Array.from(text);
      let i = 0;
      const step = () => {
        if (i < parts.length) { el.textContent += parts[i++]; typingTimer = setTimeout(step, TYPE_SPEED); }
        else { isTyping = false; el.classList.remove("caret"); done && done(); }
      };
      step();
    }
    function setCardAnimation(state) {
      const card = document.querySelector(".card");
      card.classList.remove("enter","exit"); void card.offsetWidth; card.classList.add(state);
    }
    function render() {
      const n = index + 1;
      titleEl.textContent = "Kapitel " + n;
      progressEl.textContent = "Kapitel " + n + "/" + total;
      localStorage.setItem("iris:index", String(index));
      setCardAnimation("exit");
      setTimeout(() => { textEl.textContent = ""; setCardAnimation("enter"); typeText(textEl, chapters[index]); }, 150);
    }

    /********* Audio (robust f√ºr iOS) *********/
    let audioCtx = null;
    const beepEl = document.getElementById("beepEl");

    // Erzeuge On-the-fly ein kurzes Beep-WAV und setze es als src (stabil auf iOS HTMLAudio)
    function makeWavBeep(durationMs=160, freq=880) {
      const sampleRate = 44100;
      const samples = Math.floor(sampleRate * (durationMs/1000));
      const buffer = new Uint8Array(44 + samples*2);
      function w16(o,v){ buffer[o]=v&255; buffer[o+1]=(v>>8)&255; }
      function w32(o,v){ buffer[o]=v&255; buffer[o+1]=(v>>8)&255; buffer[o+2]=(v>>16)&255; buffer[o+3]=(v>>24)&255; }
      buffer.set([82,73,70,70]); w32(4, 36 + samples*2);
      buffer.set([87,65,86,69],8); buffer.set([102,109,116,32],12); w32(16,16);
      w16(20,1); w16(22,1); w32(24,sampleRate); w32(28,sampleRate*2);
      w16(32,2); w16(34,16); buffer.set([100,97,116,97],36); w32(40, samples*2);
      const vol = 0.35;
      for (let i=0;i<samples;i++) {
        const t = i / sampleRate;
        const s = Math.sin(2*Math.PI*freq*t);
        const env = Math.min(1, i/(sampleRate*0.01)) * Math.min(1, (samples-i)/(sampleRate*0.04)); // Attack/Release
        const val = Math.max(-1, Math.min(1, s*vol*env));
        const int16 = (val*32767)|0;
        w16(44+i*2, int16);
      }
      return "data:audio/wav;base64," + btoa(String.fromCharCode.apply(null, buffer));
    }
    beepEl.setAttribute("playsinline","");
    beepEl.setAttribute("src", makeWavBeep());

    async function initAudio() {
      try {
        // WebAudio optional (f√ºr Desktop), HTMLAudio prim√§r
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") await audioCtx.resume();
        // HTMLAudio ‚Äûprimen‚Äú
        try { await beepEl.play(); beepEl.pause(); beepEl.currentTime = 0; } catch(_e) {}
        diag("Audio bereit");
      } catch(e) { diag("Audio-Init: " + e); }
    }
    async function playBeep() {
      try { beepEl.currentTime = 0; await beepEl.play(); return; }
      catch(e) {
        if (audioCtx) {
          const ctx = audioCtx;
          const o = ctx.createOscillator(); const g = ctx.createGain();
          o.type="square"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
          const now = ctx.currentTime; g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.22, now+0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
          o.start(now); o.stop(now+0.2);
        }
      }
    }
    function unlockEverythingOnce() {
      const once = async () => { await initAudio(); document.removeEventListener("pointerdown", once); };
      document.addEventListener("pointerdown", once, { passive:true, once:true });
    }
    function diag(msg){ diagEl.textContent = msg; }

    /********* Navigation *********/
    function nextChapter() {
      if (isTyping) { if (typingTimer) clearTimeout(typingTimer); textEl.textContent = chapters[index]; isTyping=false; textEl.classList.remove("caret"); return; }
      index = (index + 1) % total; playBeep(); render();
    }
    function prevChapter() {
      if (isTyping) { if (typingTimer) clearTimeout(typingTimer); textEl.textContent = chapters[index]; isTyping=false; textEl.classList.remove("caret"); return; }
      index = (index - 1 + total) % total; playBeep(); render();
    }
    function resetStory() { index = 0; playBeep(); render(); }

    document.querySelector("main").addEventListener("click", nextChapter);
    nextBtn.addEventListener("click", nextChapter);
    prevBtn.addEventListener("click", prevChapter);
    resetBtn.addEventListener("click", resetStory);
    soundBtn.addEventListener("click", initAudio);
    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight" || e.key === " " ) nextChapter();
      if (e.key === "ArrowLeft") prevChapter();
      if (e.key.toLowerCase() === "r") resetStory();
    });

    /********* Shake *********/
    let lastShake = 0;
    const SHAKE_THRESHOLD = 18;
    const SHAKE_COOLDOWN  = 900;
    let motionActive=false, gotMotion=false, gotOrient=false;

    function handleMotion(ev){
      const acc = ev.accelerationIncludingGravity || ev.acceleration;
      if (!acc) return;
      gotMotion = true;
      const x=acc.x||0,y=acc.y||0,z=acc.z||0;
      const mag = Math.sqrt(x*x + y*y + z*z);
      const now = Date.now();
      if (mag > SHAKE_THRESHOLD && (now - lastShake) > SHAKE_COOLDOWN) { lastShake = now; nextChapter(); }
    }
    function handleOrientation(){ gotOrient = true; }
    function iOSNeedsPermission(){ return typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function"; }
    function attachSensors(){
      if (motionActive) return;
      window.addEventListener("devicemotion", handleMotion, { passive:true });
      window.addEventListener("deviceorientation", handleOrientation, { passive:true });
      motionActive = true; hintEl.textContent = "Sch√ºtteln aktiv ‚Äì oder tippen zum Bl√§ttern";
    }
    async function enableMotion(){
      await initAudio(); // Audio zugleich freischalten
      try {
        if (iOSNeedsPermission()) {
          permStatus.textContent = "Frage Berechtigung an‚Ä¶";
          const state = await DeviceMotionEvent.requestPermission();
          if (state === "granted") { attachSensors(); motionOverlay.classList.remove("show"); permStatus.textContent = "Erlaubt ‚úîÔ∏é"; }
          else { permStatus.textContent = "Abgelehnt ‚úñÔ∏é ‚Äì Safari-Einstellung pr√ºfen."; }
        } else { attachSensors(); motionOverlay.classList.remove("show"); permStatus.textContent = "Aktiv ‚úîÔ∏é"; }
      } catch(e) { permStatus.textContent = "Fehler: " + e; }
    }

    enableBtn.addEventListener("click", enableMotion);
    sensorBtn.addEventListener("click", () => {
      const s = [
        "Audio: " + (beepEl ? "HTML5 ready" : "none"),
        "gotMotion: " + gotMotion,
        "gotOrientation: " + gotOrient,
        "active: " + motionActive
      ].join(" | ");
      alert(s);
    });

    // Init
    window.addEventListener("load", () => {
      unlockEverythingOnce();
      render();
      if (iOSNeedsPermission()) motionOverlay.classList.add("show"); else attachSensors();
    });
  </script>
</body>
</html>


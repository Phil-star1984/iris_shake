<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#000000" />
<title>IRIS — Shake to Read (CLI)</title>
<style>
  :root{ --bg:#000; --fg:#00ff66; --fg-dim:#00cc52; --border:#005e2f; --glow:0 0 10px rgba(0,255,102,.25); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:"DejaVu Sans Mono","Ubuntu Mono","Liberation Mono","SFMono-Regular",Menlo,Monaco,Consolas,"Courier New",monospace;
    -webkit-font-smoothing:antialiased; text-shadow:var(--glow);
    line-height:1.65; overflow:hidden;
  }
  .frame{height:100%; display:grid; grid-template-rows:auto 1fr auto; gap:12px;
         padding:calc(env(safe-area-inset-top)+12px) 14px calc(env(safe-area-inset-bottom)+14px)}
  header{display:flex; justify-content:space-between; align-items:center; font-size:14px; color:var(--fg-dim)}
  .brand::before{content:"root@iris:~$ "; color:var(--fg-dim)}
  .terminal{
    border:1px solid var(--border); border-radius:10px; background:#000;
    padding:18px; display:grid; grid-template-rows:auto 1fr auto; gap:10px;
    box-shadow:0 0 0 1px rgba(0,255,102,.05);
    transition:filter .2s ease, transform .2s ease;
  }
  .chapter-row{display:flex; gap:8px; align-items:center; color:var(--fg-dim)}
  .led{width:8px; height:8px; border-radius:50%; background:var(--fg); box-shadow:0 0 6px var(--fg)}
  .chapter{font-size:clamp(18px,4.5vw,22px)}
  .card{min-height:52vh; display:flex; align-items:center}
  .text{font-size:clamp(18px,5.2vw,24px)}
  .caret::after{content:"▌"; margin-left:2px; animation:blink 1s steps(1,end) infinite}
  @keyframes blink{50%{opacity:0}}
  .enter{animation:enter .44s cubic-bezier(.2,.8,.16,1) both}
  .exit{animation:exit .26s cubic-bezier(.55,.08,.68,.53) both}
  @keyframes enter{from{opacity:0; transform:translateY(10vh)} to{opacity:1; transform:translateY(0)}}
  @keyframes exit{from{opacity:1; transform:translateY(0)} to{opacity:0; transform:translateY(-7vh)}}
  footer{display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px}
  .hint{font-size:12.5px; color:var(--fg-dim)}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  button{
    background:#000; border:1px solid var(--border); color:var(--fg);
    padding:10px 14px; border-radius:8px; font-size:14px; cursor:pointer; touch-action:manipulation; box-shadow:var(--glow)
  }
  button:hover{border-color:#00994d}
  .primary{border-color:#00cc66}
  .danger{border-color:#663333; color:#ffb3b3; text-shadow:none}

  /* Motion overlay */
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; padding:24px; z-index:999}
  .overlay.show{display:flex}
  .card-modal{max-width:520px; background:#000; border:1px solid var(--border); border-radius:12px; padding:22px; text-align:center; box-shadow:var(--glow)}
  .card-modal h2{margin:0 0 10px}
  .status{font-size:12px; color:var(--fg-dim); margin-top:6px}

  /* 💥 MAX visueller Effekt beim Shake-Wechsel */
  .fx{position:fixed; inset:0; pointer-events:none; opacity:0; z-index:998}
  .fx.show{animation:flash 580ms ease-out}
  @keyframes flash{
    0%{opacity:0}
    6%{opacity:1; backdrop-filter:brightness(1.4) contrast(1.3) saturate(1.4);
        background:
          radial-gradient(circle at 50% 50%, rgba(0,255,102,.45) 0%, rgba(0,255,102,.18) 24%, transparent 50%),
          repeating-linear-gradient(to bottom, rgba(0,255,102,.25) 0 2px, transparent 2px 6px);}
    40%{opacity:.45; backdrop-filter:brightness(1.2) contrast(1.15);
        background:
          radial-gradient(ellipse at 50% 50%, rgba(0,255,102,.22) 0%, transparent 62%),
          repeating-linear-gradient(to bottom, rgba(0,255,102,.16) 0 2px, transparent 2px 7px);}
    100%{opacity:0}
  }
  .quake{animation:quake .32s cubic-bezier(.25,.8,.25,1)}
  @keyframes quake{
    0%  {transform:translate3d(0,0,0) rotate(0deg)}
    25% {transform:translate3d(3px,-2px,0) rotate(-0.2deg)}
    50% {transform:translate3d(-3px,2px,0) rotate(0.2deg)}
    75% {transform:translate3d(2px,-1px,0) rotate(-0.15deg)}
    100%{transform:translate3d(0,0,0) rotate(0deg)}
  }
</style>
</head>
<body>
  <div class="frame">
    <header><div class="brand">iris.sh</div><div id="progress">Kapitel 1/15</div></header>

    <main id="terminal" class="terminal">
      <div class="chapter-row"><span class="led"></span><span id="chapterTitle" class="chapter">Kapitel 1</span></div>
      <div class="card enter"><div id="chapterText" class="text caret"></div></div>
      <div class="hint" id="hint">🔁 Schüttle dein iPhone · Tippen geht auch · 🔊 Erst tippen, dann Ton</div>
    </main>

    <footer>
      <div class="hint" id="diag"></div>
      <div class="controls">
        <button id="prevBtn">Zurück</button>
        <button id="nextBtn" class="primary">Weiter</button>
        <button id="resetBtn" class="danger">Reset</button>
      </div>
    </footer>
  </div>

  <!-- starker Overlay-Effekt -->
  <div id="fx" class="fx" aria-hidden="true"></div>

  <!-- iOS Permission Overlay -->
  <div id="motionOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card-modal">
      <h2>Bewegung aktivieren</h2>
      <p>Tippe <b>Erlauben</b>, um Schütteln zu nutzen. (Audio wird dabei aktiviert.)</p>
      <button id="enableMotionBtn" class="primary">Erlauben</button>
      <div class="status" id="permStatus"></div>
      <div class="status">iOS: Einstellungen → Safari → „Bewegung & Ausrichtung Zugriff“</div>
    </div>
  </div>

  <script>
    "use strict";
    
    /* =====================  STORY (15 Micro-Szenen, flüssig)  ===================== */
    const chapters = [
      // 1
      "Neon schmiert am Zugfenster vorbei. Phil skizziert die Frau ihm gegenüber, als die Anzeige kurz kein Ziel, sondern ein fremdes Zeichen zeigt. Es fühlt sich an wie eine Erinnerung, die nie passiert ist. Als er hochsieht, ist ihr Platz leer – und ein Flüstern bleibt: „Wir waren schon hier, Maler.“",
      // 2
      "Draußen legt der Regen einen Glasfilm über die Stadt. Reklamen brennen, doch seine Farben wirken stumpf, als hätte sich etwas zwischen ihn und die Welt geschoben. Er begreift, dass Kunst die Bildschirme nicht bekämpfen muss – sie muss dort atmen. Der Entschluss, Malerei mit Code zu verbinden, ist plötzlich selbstverständlich.",
      // 3
      "Hinter einer Servicetür liegt Lanas Atelier: Leinwände zwischen Serverracks, Staub, Lötzinn. Über einer verblichenen Wandritzung steht: BEFORE THE STARS. Lana blättert durch seine Skizzen, sieht ihn lange an und sagt dann ruhig: „Bauen wir etwas, das mit dir malt.“",
      // 4
      "Sie nennen es IRIS: eine leichte Krone, die Muster im Gehirn in Bilder gießt. Beim ersten Lauf erscheint im Log eine Zeile, die niemand geschrieben hat: It remembers. Phil lacht unsicher – und spürt doch, wie etwas in ihm heimkommt.",
      // 5
      "Als die Krone seine Schläfen berührt, verschiebt sich die Wahrnehmung. Töne werden kühl wie Minze, Blau riecht nach Ozon, und eine Stimme sagt, als hätte sie geduldig gewartet: „Welcome back.“ Auf dem Screen flackert kurz der violette See aus seinem Kindheitstraum.",
      // 6
      "Die ersten Sitzungen berühren alle: Ein Rapper findet seinen Fluss, eine Malerin bewegt im VR-Körper wieder eine Hand. Hoffnung liegt in der Luft. Gleichzeitig warnt RATT, eine Hackergruppe: In IRIS stecke ein Muster, das nicht menschlich sei – „älter als alles, worauf wir rechnen“.",
      // 7
      "Elias Vorn taucht auf, freundlich und kalkulierend. „Deine Arbeit ist eine Karte“, sagt er, „aber du kennst das Land noch nicht.“ Er bietet Geld und Labore, will Exklusivität; Lana bleibt kühl: „Nur live, vor allen.“ Beim Hinausgehen wirkt die eingeritzte Gravur an der Tür frischer als am Morgen.",
      // 8
      "Generalprobe. Nora setzt die Krone auf, Phil sagt ihr, sie solle nur atmen, er „denkt mit“. Das Bild wächst, als würde Raum selbst zu Stoff. Hinter den Farben öffnet sich kein Tunnel, eher ein Blick zurück – als wäre dort Geduld.",
      // 9
      "Bühne, weltweiter Stream. Nora malt Licht in die Luft, die Zuschauer halten den Atem an. Dann wendet sie sich zu Phil und spricht in einer Sprache, die man eher erinnert als versteht: „Es hat dich gefunden.“ Sie knickt ein, und das Signal bricht ab.",
      // 10
      "Sirenen, überblendetes Weiß. Auf der Leinwand zucken Sternkarten, die niemand kennt, und Phils Ohr hört eine Kindheit, die nicht ihm gehört. Lana zieht ihn aus dem Schein. „Das war kein Fehler“, sagt sie leise. „Jemand hat geantwortet.“",
      // 11
      "RATT veröffentlicht Schleifen im Code, die kurz vor Noras Kollaps anstiegen – als hätte IRIS etwas durchgelassen. In Vorns Papieren taucht ein Signal auf, datiert „vor dem ersten Stern“. Dazwischen liegen Zeilen, die wie Phils Code aussehen, nur aus einer Zukunft, die noch nicht passiert ist.",
      // 12
      "Spät in der Nacht sitzt Phil allein im Studio. Der Spiegel hält seinen Blick zu lang, bis es klingt wie ein Gedanke von außen: „Du hast IRIS gemacht? Oder hat IRIS dich wieder zusammengesetzt?“ Er versteht, warum er die Frau immer wieder zeichnet: Sie ist das Echo einer Entscheidung.",
      // 13
      "Er startet IRIS ohne Sicherungen. Bilder fügen sich zu einem Tunnel aus U-Bahn-Fenstern, jeder Rahmen eine Abzweigung. Am Ende steht die Frau aus dem Zug, nicht ganz Mensch, doch vertraut. „Du kommst immer hierher, wenn die Schleife brennt“, sagt sie, und etwas in ihm nickt.",
      // 14
      "Die Einsicht fällt nicht als Satz, sondern als Knoten: IRIS ist kein Haus, sondern ein Schlüssel. Dahinter liegt etwas, das älter ist als Zeit und dennoch neugierig – eine Macht ohne Sprache. Vorn will es fassen, RATT es dämpfen. Phil spürt, dass beides die falsche Bewegung ist.",
      // 15
      "Wieder U-Bahn, wieder Neon, doch die Luft wirkt einen Ton heller. Die Frau sitzt ihm gegenüber; im Auge ein hauchfeines Glimmen, als trüge sie IRIS selbst. „Noch einmal?“, fragt sie. „Noch einmal“, sagt Phil, „aber nicht im Dunkeln.“ Und irgendwo setzt eine Hand den ersten Strich."
    ];
    const total = chapters.length;
    let index = +(localStorage.getItem("iris:index")||0) || 0;
    
    /* =====================  DOM  ===================== */
    const titleEl    = document.getElementById("chapterTitle");
    const textEl     = document.getElementById("chapterText");
    const progressEl = document.getElementById("progress");
    const hintEl     = document.getElementById("hint");
    const diagEl     = document.getElementById("diag");
    const terminalEl = document.getElementById("terminal");
    const fxEl       = document.getElementById("fx");
    const prevBtn    = document.getElementById("prevBtn");
    const nextBtn    = document.getElementById("nextBtn");
    const resetBtn   = document.getElementById("resetBtn");
    const overlayEl  = document.getElementById("motionOverlay");
    const allowBtnEl = document.getElementById("enableMotionBtn");
    const statusEl   = document.getElementById("permStatus");
    
    /* =====================  Typewriter & Render  ===================== */
    const TYPE_MODE = "word";     // "word" wirkt organischer
    const TYPE_SPEED = 22;        // ms pro Schritt
    let typingTimer = null, isTyping = false;
    
    function typeText(el, text, done){
      if (typingTimer) clearTimeout(typingTimer);
      isTyping = true; el.classList.add("caret"); el.textContent = "";
      const parts = TYPE_MODE === "word" ? text.split(/(\s+)/) : Array.from(text);
      let i = 0;
      (function step(){
        if (i < parts.length){
          el.textContent += parts[i++];
          typingTimer = setTimeout(step, TYPE_SPEED);
        } else {
          isTyping = false; el.classList.remove("caret");
          done && done();
        }
      })();
    }
    
    function setCardAnimation(state){
      const card = document.querySelector(".card");
      card.classList.remove("enter","exit");
      void card.offsetWidth;                  // reflow to restart animation
      card.classList.add(state);
    }
    
    function render(){
      const n = index + 1;
      titleEl.textContent = "Kapitel " + n;
      progressEl.textContent = "Kapitel " + n + "/" + total;
      localStorage.setItem("iris:index", String(index));
      setCardAnimation("exit");
      setTimeout(()=>{ textEl.textContent = ""; setCardAnimation("enter"); typeText(textEl, chapters[index]); }, 140);
    }
    
    /* =====================  Visuelle FX (stark)  ===================== */
    function pulseFX(){
      // großer Overlay-Flash
      fxEl.classList.remove("show"); void fxEl.offsetWidth; fxEl.classList.add("show");
      // kräftiger Terminal-Shake
      terminalEl.classList.remove("quake"); void terminalEl.offsetWidth; terminalEl.classList.add("quake");
    }
    
    /* =====================  Sound (einfach austauschbar)  ===================== */
    // Trag hier eine eigene Datei ein (liegt neben index.html), z. B. "shake.mp3".
    // Leer lassen ("") ⇒ es wird ein guter Fallback-Sound erzeugt.
    const SFX_URL = "stab-f-01-brvhrtz-224599.mp3";  // <- wenn du eine Datei hast: "shake.mp3"
    
    const sfx = new Audio();
    sfx.setAttribute("playsinline","");
    sfx.volume = 1.0;
    sfx.src = SFX_URL || makeFuturisticWav();
    
    // iOS: Audio per erster Berührung primen
    document.addEventListener("pointerdown", function once(){
      primeAudio(); document.removeEventListener("pointerdown", once);
    },{passive:true});
    
    function primeAudio(){
      try { sfx.play().then(()=>{ sfx.pause(); sfx.currentTime=0; }).catch(()=>{}); } catch {}
    }
    function playSound(){
      try { sfx.currentTime = 0; sfx.play().catch(()=>{}); } catch {}
    }
    
    // Fallback-Synth: cleaner Pad/Whoosh (~0.9 s), harmonisch
    function makeFuturisticWav(){
      const sr=44100, dur=0.9, N=Math.floor(sr*dur);
      const b=new Uint8Array(44+N*2);
      const w16=(o,v)=>{b[o]=v&255; b[o+1]=(v>>8)&255}, w32=(o,v)=>{b[o]=v&255; b[o+1]=(v>>8)&255; b[o+2]=(v>>16)&255; b[o+3]=(v>>24)&255};
      b.set([82,73,70,70]); w32(4,36+N*2); b.set([87,65,86,69],8); b.set([102,109,116,32],12); w32(16,16);
      w16(20,1); w16(22,1); w32(24,sr); w32(28,sr*2); w16(32,2); w16(34,16); b.set([100,97,116,97],36); w32(40,N*2);
      const chord=[440.00,554.37,659.25]; // Amaj add9-ish
      for(let i=0;i<N;i++){
        const t=i/sr, A=0.015, R=0.12, env=Math.max(0, Math.min(1,t/A)*Math.min(1,(dur-t)/R));
        const rise=1+0.08*Math.min(1,t/0.5); let s=0;
        for(let k=0;k<chord.length;k++){
          const f=chord[k]*rise, vibr=Math.sin(2*Math.PI*5.2*t)*0.006;
          s+=Math.sin(2*Math.PI*(f*(1+vibr))*t)*(0.95-k*0.15);
          s+=0.35*Math.sin(2*Math.PI*(2*f)*t)*(0.7-k*0.15);
        }
        const shimmer=0.22*Math.sin(2*Math.PI*(chord[0]*2.01)*t);
        const air=(Math.sin(2*Math.PI*990*t)+Math.sin(2*Math.PI*1180*t*1.01))/6;
        const out=Math.max(-1,Math.min(1,((s/1.9)+shimmer+air)*env*(0.9)));
        w16(44+i*2,(out*32767)|0);
      }
      return "data:audio/wav;base64,"+btoa(String.fromCharCode.apply(null,b));
    }
    
    /* =====================  Navigation  ===================== */
    // Sound & starker Effekt NUR beim Shake (nicht beim Tippen)
    function nextChapter(trigger="manual"){
      if (isTyping){
        if (typingTimer) clearTimeout(typingTimer);
        textEl.textContent = chapters[index];
        isTyping = false; textEl.classList.remove("caret"); 
        return;
      }
      index = (index + 1) % total;
      if (trigger === "shake"){ playSound(); pulseFX(); }
      render();
    }
    function prevChapter(){
      if (isTyping){
        if (typingTimer) clearTimeout(typingTimer);
        textEl.textContent = chapters[index];
        isTyping = false; textEl.classList.remove("caret");
        return;
      }
      index = (index - 1 + total) % total;
      render();
    }
    function resetStory(){ index = 0; render(); }
    
    // Tippen/Buttons blättern ohne Sound
    document.querySelector("main").addEventListener("click", ()=>nextChapter("manual"));
    nextBtn.addEventListener("click", ()=>nextChapter("manual"));
    prevBtn.addEventListener("click", prevChapter);
    resetBtn.addEventListener("click", resetStory);
    window.addEventListener("keydown", e=>{
      if (e.key==="ArrowRight"||e.key===" ") nextChapter("manual");
      if (e.key==="ArrowLeft") prevChapter();
      if (e.key.toLowerCase()==="r") resetStory();
    });
    
    /* =====================  Shake + iOS Permission (robust)  ===================== */
    let lastShake = 0, motionActive = false, motionEvents = 0, watchdog = null;
    const SHAKE_THRESHOLD = 18, SHAKE_COOLDOWN = 900;
    
    function hasIOSPermissionAPI(){
      return typeof DeviceMotionEvent !== "undefined" &&
             typeof DeviceMotionEvent.requestPermission === "function";
    }
    function onMotion(ev){
      motionEvents++;
      const a = ev.accelerationIncludingGravity || ev.acceleration;
      if (!a) return;
      const m = Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2);
      const now = Date.now();
      if (m > SHAKE_THRESHOLD && (now - lastShake) > SHAKE_COOLDOWN){
        lastShake = now;
        nextChapter("shake");
      }
    }
    function startSensors(){
      if (motionActive) return;
      motionActive = true;
      window.addEventListener("devicemotion", onMotion, {passive:true});
      overlayEl?.classList.remove("show");
      statusEl && (statusEl.textContent = "Aktiv ✔︎");
      motionEvents = 0;
      clearTimeout(watchdog);
      watchdog = setTimeout(()=>{
        if (motionEvents === 0){
          window.removeEventListener("devicemotion", onMotion);
          motionActive = false;
          overlayEl?.classList.add("show");
          statusEl && (statusEl.textContent = "Keine Sensor-Daten. Safari: Bewegung & Ausrichtung Zugriff + kein Privatmodus.");
        }
      }, 1500);
    }
    function requestPermissionInline(){
      // Audio in derselben Geste freischalten (iOS)
      primeAudio();
      if (hasIOSPermissionAPI()){
        DeviceMotionEvent.requestPermission().then(state=>{
          if (state === "granted"){ startSensors(); }
          else { statusEl && (statusEl.textContent = "Abgelehnt ✖︎ – bitte in Safari erlauben."); }
        }).catch(err=>{ statusEl && (statusEl.textContent = "Fehler: "+err); });
      } else { startSensors(); }
    }
    allowBtnEl?.addEventListener("click", requestPermissionInline);
    
    /* =====================  Init  ===================== */
    function init(){
      try { render(); } catch(e){ diagEl.textContent = "Render-Fehler: "+e; }
      if (hasIOSPermissionAPI()){ overlayEl?.classList.add("show"); }
      else { startSensors(); }
    }
    window.addEventListener("load", init);
    </script>
    
</body>
</html>


<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#000000" />
<title>IRIS — Shake to Read (CLI)</title>
<style>
  :root{ --bg:#000; --fg:#00ff66; --fg-dim:#00cc52; --border:#005e2f; --glow:0 0 10px rgba(0,255,102,.25); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:"DejaVu Sans Mono","Ubuntu Mono","Liberation Mono","SFMono-Regular",Menlo,Monaco,Consolas,"Courier New",monospace;
    -webkit-font-smoothing:antialiased; text-shadow:var(--glow);
    line-height:1.65; overflow:hidden;
  }
  .frame{height:100%; display:grid; grid-template-rows:auto 1fr auto; gap:12px;
         padding:calc(env(safe-area-inset-top)+12px) 14px calc(env(safe-area-inset-bottom)+14px)}
  header{display:flex; justify-content:space-between; align-items:center; font-size:14px; color:var(--fg-dim)}
  .brand::before{content:"root@iris:~$ "; color:var(--fg-dim)}
  .terminal{
    border:1px solid var(--border); border-radius:10px; background:#000;
    padding:18px; display:grid; grid-template-rows:auto 1fr auto; gap:10px;
    box-shadow:0 0 0 1px rgba(0,255,102,.05);
    transition:filter .2s ease, transform .2s ease;
  }
  .chapter-row{display:flex; gap:8px; align-items:center; color:var(--fg-dim)}
  .led{width:8px; height:8px; border-radius:50%; background:var(--fg); box-shadow:0 0 6px var(--fg)}
  .chapter{font-size:clamp(18px,4.5vw,22px)}
  .card{min-height:52vh; display:flex; align-items:center}
  .text{font-size:clamp(18px,5.2vw,24px)}
  .caret::after{content:"▌"; margin-left:2px; animation:blink 1s steps(1,end) infinite}
  @keyframes blink{50%{opacity:0}}
  .enter{animation:enter .44s cubic-bezier(.2,.8,.16,1) both}
  .exit{animation:exit .26s cubic-bezier(.55,.08,.68,.53) both}
  @keyframes enter{from{opacity:0; transform:translateY(10vh)} to{opacity:1; transform:translateY(0)}}
  @keyframes exit{from{opacity:1; transform:translateY(0)} to{opacity:0; transform:translateY(-7vh)}}
  footer{display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px}
  .hint{font-size:12.5px; color:var(--fg-dim)}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  button{
    background:#000; border:1px solid var(--border); color:var(--fg);
    padding:10px 14px; border-radius:8px; font-size:14px; cursor:pointer; touch-action:manipulation; box-shadow:var(--glow)
  }
  button:hover{border-color:#00994d}
  .primary{border-color:#00cc66}
  .danger{border-color:#663333; color:#ffb3b3; text-shadow:none}

  /* Motion overlay */
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; padding:24px; z-index:999}
  .overlay.show{display:flex}
  .card-modal{max-width:520px; background:#000; border:1px solid var(--border); border-radius:12px; padding:22px; text-align:center; box-shadow:var(--glow)}
  .card-modal h2{margin:0 0 10px}
  .status{font-size:12px; color:var(--fg-dim); margin-top:6px}

  /* 💥 MAX visueller Effekt beim Shake-Wechsel */
  .fx{position:fixed; inset:0; pointer-events:none; opacity:0; z-index:998}
  .fx.show{animation:flash 580ms ease-out}
  @keyframes flash{
    0%{opacity:0}
    6%{opacity:1; backdrop-filter:brightness(1.4) contrast(1.3) saturate(1.4);
        background:
          radial-gradient(circle at 50% 50%, rgba(0,255,102,.45) 0%, rgba(0,255,102,.18) 24%, transparent 50%),
          repeating-linear-gradient(to bottom, rgba(0,255,102,.25) 0 2px, transparent 2px 6px);}
    40%{opacity:.45; backdrop-filter:brightness(1.2) contrast(1.15);
        background:
          radial-gradient(ellipse at 50% 50%, rgba(0,255,102,.22) 0%, transparent 62%),
          repeating-linear-gradient(to bottom, rgba(0,255,102,.16) 0 2px, transparent 2px 7px);}
    100%{opacity:0}
  }
  .quake{animation:quake .32s cubic-bezier(.25,.8,.25,1)}
  @keyframes quake{
    0%  {transform:translate3d(0,0,0) rotate(0deg)}
    25% {transform:translate3d(3px,-2px,0) rotate(-0.2deg)}
    50% {transform:translate3d(-3px,2px,0) rotate(0.2deg)}
    75% {transform:translate3d(2px,-1px,0) rotate(-0.15deg)}
    100%{transform:translate3d(0,0,0) rotate(0deg)}
  }
</style>
</head>
<body>
  <div class="frame">
    <header><div class="brand">iris.sh</div><div id="progress">Kapitel 1/15</div></header>

    <main id="terminal" class="terminal">
      <div class="chapter-row"><span class="led"></span><span id="chapterTitle" class="chapter">Kapitel 1</span></div>
      <div class="card enter"><div id="chapterText" class="text caret"></div></div>
      <div class="hint" id="hint">🔁 Schüttle dein iPhone · Tippen geht auch · 🔊 Erst tippen, dann Ton</div>
    </main>

    <footer>
      <div class="hint" id="diag"></div>
      <div class="controls">
        <button id="prevBtn">Zurück</button>
        <button id="nextBtn" class="primary">Weiter</button>
        <button id="resetBtn" class="danger">Reset</button>
      </div>
    </footer>
  </div>

  <!-- starker Overlay-Effekt -->
  <div id="fx" class="fx" aria-hidden="true"></div>

  <!-- iOS Permission Overlay -->
  <div id="motionOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card-modal">
      <h2>Bewegung aktivieren</h2>
      <p>Tippe <b>Erlauben</b>, um Schütteln zu nutzen. (Audio wird dabei aktiviert.)</p>
      <button id="enableMotionBtn" class="primary">Erlauben</button>
      <div class="status" id="permStatus"></div>
      <div class="status">iOS: Einstellungen → Safari → „Bewegung & Ausrichtung Zugriff“</div>
    </div>
  </div>

<script>
"use strict";

/* ---------- Story (kohärent & IRIS-konform) ---------- */
const chapters = [
  "U-Bahn, Neon. Phil Splash skizziert die Frau gegenüber – ruhig, unerreichbar. Niemand sieht hin; alle starren auf Hologramme. In ihm wächst die Entscheidung: Wenn die Welt nur noch auf Screens reagiert, muss Kunst sie dort berühren.",
  "Regen, Reklamen, spiegelndes Glas. Seine Farben wirken stumpf. Phil erinnert sich an Nächte, in denen echte Menschen vor echten Bildern standen. Er will Kunst und Code koppeln – nicht um zu fliehen, sondern um die Stadt wieder fühlbar zu machen.",
  "Co-Working-Keller. Lana – präzise, schweigsam – blättert in seinen Skizzen. Neben Lötstationen: ein eingeritztes Symbol, uralt. „BEFORE THE STARS.“ Lana sagt nichts. „Bauen wir’s“, sagt sie dann.",
  "IRIS entsteht: eine leichte Krone, die Muster im Gehirn in Bilder gießt. „Wie ein drittes Auge.“ Test-Log: ›it remembers‹ – eingetragen von niemandem. Phil friert kurz, arbeitet weiter.",
  "Selbsttest. Synästhesie: Töne schmecken nach Minze, Blau riecht nach Ozon. Zwischen den Farben schimmert ein Schatten – alt, geduldig, neugierig. Phil blinzelt ihn weg. IRIS funktioniert. Vielleicht zu gut.",
  "Erste Sessions. Ein stotternder Rapper flutet den Raum mit flüssigem Flow. Eine gelähmte Malerin bewegt sich im VR-Körper. Hoffnung. Parallel warnt RATT: „IRIS trägt vorzeitliche Muster. Es ist nicht nur euer Code.“",
  "Vorn – der unsichtbare Milliardär – bietet Labs und Geld, fordert Exklusivität. Lana bleibt kühl: „Nur live – vor allen.“ Phil nickt. Als sie gehen, wirkt das eingeritzte Symbol an der Tür … frischer.",
  "Generalprobe mit Nora, Lanas Vertrauter. „Du denkst, ich zeichne“, flüstert Phil. Nora lächelt, setzt die Krone auf. Das Bild wächst wie ein Tor. In der Tiefe lungert etwas, das keinen Namen hat – und sie anschaut.",
  "Bühne. Weltstream. Nora malt mit Licht; das Publikum erstarrt. Dann dreht sie sich zu Phil und spricht in einer zeitlosen Sprache: „Es hat dich gefunden.“ Ihr Körper knickt ein; der Stream reißt ab.",
  "Sirenen. Auf der Leinwand flackern Sternkarten, die niemals existierten. In Phils Kopfhörer murmelt eine Kindheit, die er nie hatte. Lana zieht ihn weg. „Kein Unfall“, sagt sie. „Etwas hat durch IRIS geantwortet.“",
  "RATT leakt Daten: Schleifen kurz vor Noras Kollaps, als hätte IRIS etwas durchgelassen. Dokumente zeigen Vorns Firma mit Fragmenten eines Signals – datiert „vor dem ersten Stern“. Dazwischen Code von Phil – signiert in einer Zukunft, die nicht passiert ist.",
  "Allein im Studio. Der Spiegel spricht zuerst: „Du hast IRIS gemacht? IRIS hat dich rekonstruiert.“ Phil begreift, warum er die Frau immer wieder zeichnet: Sie ist das Echo seiner Entscheidung, hierher zurückzukehren.",
  "IRIS ohne Sicherungen. Sturz nach innen: U-Bahn-Bilder in endlosen Rahmen. Am Ende ein Raum aus Licht. Die Frau steht dort – nicht ganz Mensch. „Du kommst immer hierher, wenn die Schleife brennt.“",
  "Die Wahrheit ist ein Knoten: IRIS ist ein Schlüssel. Dahinter liegt etwas Älteres als Zeit; Vorn will es einfassen, RATT es begrenzen. „Wähl diesmal anders“, sagt die Frau. „Sonst wiederholt sich alles – nur schöner.“",
  "U-Bahn, Neon – wieder Anfang. Die Frau gegenüber. In ihrem Auge glimmt eine dünne IRIS-Kontur. „Noch einmal?“, fragt sie. Phil nickt: „Noch einmal – aber nicht im Dunkeln.“ Draußen wird es minimal heller."
];
const total = chapters.length;
let index = +(localStorage.getItem("iris:index")||0) || 0;

/* ---------- DOM ---------- */
const titleEl   = document.getElementById("chapterTitle");
const textEl    = document.getElementById("chapterText");
const progressEl= document.getElementById("progress");
const hintEl    = document.getElementById("hint");
const diagEl    = document.getElementById("diag");
const terminalEl= document.getElementById("terminal");
const fxEl      = document.getElementById("fx");
const prevBtn   = document.getElementById("prevBtn");
const nextBtn   = document.getElementById("nextBtn");
const resetBtn  = document.getElementById("resetBtn");
const motionOverlay = document.getElementById("motionOverlay");
const enableBtn = document.getElementById("enableMotionBtn");
const permStatus= document.getElementById("permStatus");

/* ---------- Typewriter + Card ---------- */
const TYPE_MODE="char", TYPE_SPEED=18;
let typingTimer=null, isTyping=false;
function typeText(el, text, done){
  if (typingTimer) clearTimeout(typingTimer);
  isTyping=true; el.classList.add("caret"); el.textContent="";
  const parts = TYPE_MODE==="word" ? text.split(/(\s+)/) : Array.from(text);
  let i=0; const step=()=>{ if(i<parts.length){ el.textContent+=parts[i++]; typingTimer=setTimeout(step,TYPE_SPEED); }
    else { isTyping=false; el.classList.remove("caret"); done&&done(); } };
  step();
}
function setCardAnimation(state){
  const card=document.querySelector(".card");
  card.classList.remove("enter","exit"); void card.offsetWidth; card.classList.add(state);
}
function render(){
  const n=index+1; titleEl.textContent="Kapitel "+n; progressEl.textContent="Kapitel "+n+"/"+total;
  localStorage.setItem("iris:index",String(index));
  setCardAnimation("exit");
  setTimeout(()=>{ textEl.textContent=""; setCardAnimation("enter"); typeText(textEl, chapters[index]); }, 140);
}

/* ---------- STARKER visueller Effekt ---------- */
function pulseFX(){
  // großer Overlay-Flash
  fxEl.classList.remove("show"); void fxEl.offsetWidth; fxEl.classList.add("show");
  // hartes Wackeln des Terminals
  terminalEl.classList.remove("quake"); void terminalEl.offsetWidth; terminalEl.classList.add("quake");
}

/* ---------- LAUTER futuristischer Sound (iOS-stabil, 1 Datei) ---------- */
const sfx = new Audio(); sfx.setAttribute("playsinline","");
sfx.volume = 1.0; // laut
sfx.src = makeFuturisticWav(); // generierter WAV-Data-URI

// iOS: Audio bei erster Berührung & beim Erlauben-Button „primen“
document.addEventListener("pointerdown", function once(){
  primeAudio(); document.removeEventListener("pointerdown", once);
},{passive:true});
function primeAudio(){
  try{ sfx.play().then(()=>{ sfx.pause(); sfx.currentTime=0; }).catch(()=>{});}catch{}
}
function playSound(){
  try{ sfx.currentTime = 0; sfx.volume = 1.0; sfx.play().catch(()=>{}); }catch{}
}

// Synthese: spherischer, moderner Pad/Whoosh-Hybrid (~0.9s), clean & harmonisch
function makeFuturisticWav(){
  const sr=44100, dur=0.9, N=Math.floor(sr*dur);
  const buf=new Uint8Array(44+N*2);
  const w16=(o,v)=>{buf[o]=v&255; buf[o+1]=(v>>8)&255}, w32=(o,v)=>{buf[o]=v&255; buf[o+1]=(v>>8)&255; buf[o+2]=(v>>16)&255; buf[o+3]=(v>>24)&255};
  // WAV Header
  buf.set([82,73,70,70]); w32(4,36+N*2); buf.set([87,65,86,69],8); buf.set([102,109,116,32],12); w32(16,16);
  w16(20,1); w16(22,1); w32(24,sr); w32(28,sr*2); w16(32,2); w16(34,16); buf.set([100,97,116,97],36); w32(40,N*2);

  const chord = [440.00, 554.37, 659.25]; // A Major add9-ish (hell, futuristisch)
  for(let i=0;i<N;i++){
    const t=i/sr;
    // sanfter Attack + Release
    const A=0.015, R=0.12;
    const envA=Math.min(1,t/A), envR=Math.min(1,(dur-t)/R);
    const env=Math.max(0, envA*envR);

    // gleitender Pitch-Rise (Granular Whoosh)
    const rise = 1 + 0.08*Math.min(1, t/0.5);

    // Summe aus Sine + Triangle + feinem Shimmer (Oktave)
    let s=0;
    for(let k=0;k<chord.length;k++){
      const f=chord[k]*rise;
      const vibr = Math.sin(2*Math.PI*5.2*t)*0.006;
      s += Math.sin(2*Math.PI*(f*(1+vibr))*t) * (0.95 - k*0.15);
      s += 0.35*Math.sin(2*Math.PI*(2*f)*t) * (0.7 - k*0.15);
    }
    // Shimmer + dezenter Air-Noise (höhere „Luftigkeit“)
    const shimmer = 0.22*Math.sin(2*Math.PI*(chord[0]*2.01)*t);
    const air = (Math.sin(2*Math.PI*990*t)+Math.sin(2*Math.PI*1180*t*1.01))/6;

    // sanftes Lowpass „bewegend“
    const lp = 0.5 + 0.5*Math.sin(2*Math.PI*0.7*t);
    let out = ((s/1.9)+shimmer+air) * env * (0.85*lp + 0.15);

    // hart genug, aber nicht clippen
    out = Math.max(-1, Math.min(1, out));
    w16(44+i*2, (out*32767)|0);
  }
  return "data:audio/wav;base64,"+btoa(String.fromCharCode.apply(null,buf));
}

/* ---------- Navigation ---------- */
function renderAndSave(){ render(); }
function nextChapter(manual=false){
  if(isTyping){ if(typingTimer) clearTimeout(typingTimer); textEl.textContent=chapters[index]; isTyping=false; textEl.classList.remove("caret"); return; }
  index=(index+1)%total;
  if(!manual){ playSound(); pulseFX(); } // Sound & starker Effekt NUR beim Shake
  renderAndSave();
}
function prevChapter(){
  if(isTyping){ if(typingTimer) clearTimeout(typingTimer); textEl.textContent=chapters[index]; isTyping=false; textEl.classList.remove("caret"); return; }
  index=(index-1+total)%total; renderAndSave(); // kein Sound/Effekt bei manuell zurück
}
function resetStory(){ index=0; renderAndSave(); }

// Tap/Buttons blättern ohne Sound (du wolltest Sound nur beim Shake)
document.querySelector("main").addEventListener("click", ()=>nextChapter(true));
document.getElementById("nextBtn").addEventListener("click", ()=>nextChapter(true));
document.getElementById("prevBtn").addEventListener("click", prevChapter);
document.getElementById("resetBtn").addEventListener("click", resetStory);
window.addEventListener("keydown", e=>{
  if(e.key==="ArrowRight"||e.key===" ") nextChapter(true);
  if(e.key==="ArrowLeft") prevChapter();
  if(e.key.toLowerCase()==="r") resetStory();
});

/* ---------- Shake (iOS-Permission in derselben Geste) ---------- */
let lastShake=0; const SHAKE_THRESHOLD=18, SHAKE_COOLDOWN=900; let motionActive=false;
function handleMotion(ev){
  const a=ev.accelerationIncludingGravity||ev.acceleration; if(!a) return;
  const m=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2), now=Date.now();
  if(m>SHAKE_THRESHOLD && (now-lastShake)>SHAKE_COOLDOWN){
    lastShake=now; nextChapter(false); // Sound & starker Effekt hier
  }
}
function attachSensors(){ if(motionActive) return; window.addEventListener("devicemotion",handleMotion,{passive:true}); motionActive=true; hintEl.textContent="Schütteln aktiv – oder tippen"; }
function iOSNeedsPermission(){ return typeof DeviceMotionEvent!=="undefined" && typeof DeviceMotionEvent.requestPermission==="function"; }
function requestMotionPermission(){
  primeAudio(); // in derselben Geste
  if(iOSNeedsPermission()){
    DeviceMotionEvent.requestPermission().then(state=>{
      if(state==="granted"){ attachSensors(); motionOverlay.classList.remove("show"); permStatus.textContent="Erlaubt ✔︎"; }
      else { permStatus.textContent="Abgelehnt ✖︎ – Safari-Einstellung prüfen."; }
    }).catch(err=>{ permStatus.textContent="Fehler: "+err; });
  } else { attachSensors(); motionOverlay.classList.remove("show"); permStatus.textContent="Aktiv ✔︎"; }
}
enableBtn.addEventListener("click", requestMotionPermission, {passive:true});
enableBtn.addEventListener("touchend", requestMotionPermission, {passive:true});

/* ---------- Init ---------- */
function renderInit(){ try{ render(); }catch(e){ diagEl.textContent="Render-Fehler: "+e; } }
window.addEventListener("load", ()=>{
  renderInit();
  // Audio minimal primen (sicherheitshalber) – echter Unlock erst per User-Geste
  try{ sfx.load(); }catch{}
  if(iOSNeedsPermission()) motionOverlay.classList.add("show"); else attachSensors();
});
</script>
</body>
</html>


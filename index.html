<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>IRIS ‚Äî Shake to Read (CLI)</title>
  <style>
    :root{
      --bg:#000;             /* pures Schwarz */
      --fg:#00ff66;          /* leuchtendes Terminal-Gr√ºn */
      --fg-dim:#00cc52;      /* gedimmt */
      --accent:#00ff66;
      --border:#005e2f;
      --glow:0 0 10px rgba(0,255,102,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:"DejaVu Sans Mono","Ubuntu Mono","Liberation Mono","SFMono-Regular",Menlo,Monaco,Consolas,"Courier New",monospace;
      -webkit-font-smoothing:antialiased; text-shadow:var(--glow);
      line-height:1.6; overflow:hidden;
    }
    .frame{height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px;
      padding:calc(env(safe-area-inset-top)+12px) 14px calc(env(safe-area-inset-bottom)+14px)}
    header{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:var(--fg-dim)}
    .brand::before{content:"root@iris:~$ ";color:var(--fg-dim)}
    .terminal{
      border:1px solid var(--border);border-radius:10px;
      padding:18px;display:grid;grid-template-rows:auto 1fr auto;gap:10px; background:#000;
      box-shadow:0 0 0 1px rgba(0,255,102,.05);
    }
    .chapter-row{display:flex;gap:8px;align-items:center;color:var(--fg-dim)}
    .led{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent)}
    .chapter{font-size:clamp(18px,4.5vw,22px)}
    .card{min-height:52vh;display:flex;align-items:center}
    .text{font-size:clamp(18px,5.6vw,24px)}
    .caret::after{content:"‚ñå";margin-left:2px;animation:blink 1s steps(1,end) infinite}
    @keyframes blink{50%{opacity:0}}
    .enter{animation:enter .4s cubic-bezier(.2,.8,.16,1) both}
    .exit{animation:exit .25s cubic-bezier(.55,.08,.68,.53) both}
    @keyframes enter{from{opacity:0;transform:translateY(10vh)}to{opacity:1;transform:translateY(0)}}
    @keyframes exit{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-6vh)}}
    footer{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
    .hint{font-size:12.5px;color:var(--fg-dim)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{
      background:#000;border:1px solid var(--border);color:var(--fg);
      padding:10px 14px;border-radius:8px;font-size:14px;cursor:pointer;touch-action:manipulation;
      box-shadow:var(--glow)
    }
    button:hover{border-color:#00994d}
    .primary{border-color:#00cc66}
    .danger{border-color:#663333;color:#ffb3b3;text-shadow:none}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;padding:24px;z-index:999}
    .overlay.show{display:flex}
    .card-modal{max-width:520px;background:#000;border:1px solid var(--border);border-radius:12px;padding:22px;text-align:center;box-shadow:var(--glow)}
    .card-modal h2{margin:0 0 10px}
    .status{font-size:12px;color:var(--fg-dim);margin-top:6px}
  </style>
</head>
<body>
  <div class="frame">
    <header><div class="brand">iris.sh</div><div id="progress">Kapitel 1/15</div></header>

    <main class="terminal">
      <div class="chapter-row"><span class="led"></span><span id="chapterTitle" class="chapter">Kapitel 1</span></div>
      <div class="card enter"><div id="chapterText" class="text caret"></div></div>
      <div class="hint" id="hint">üîÅ Sch√ºttle dein iPhone ¬∑ Tippen geht auch ¬∑ üîä Erst tippen, dann Ton</div>
    </main>

    <footer>
      <div class="hint" id="diag"></div>
      <div class="controls">
        <button id="prevBtn">Zur√ºck</button>
        <button id="nextBtn" class="primary">Weiter</button>
        <button id="resetBtn" class="danger">Reset</button>
        <button id="soundBtn">Audio</button>
        <button id="sensorBtn">Sensor</button>
      </div>
    </footer>
  </div>

  <!-- Beep als HTMLAudio (iOS-stabil) -->
  <audio id="beepEl" preload="auto"></audio>

  <!-- iOS Permission Overlay -->
  <div id="motionOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="card-modal">
      <h2>Bewegung aktivieren</h2>
      <p>Tippe <b>Erlauben</b>, um Sch√ºtteln zu nutzen. (Audio wird dabei aktiviert.)</p>
      <button id="enableMotionBtn" class="primary">Erlauben</button>
      <div class="status" id="permStatus"></div>
      <div class="status">iOS: Einstellungen ‚Üí Safari ‚Üí ‚ÄûBewegung & Ausrichtung Zugriff‚Äú</div>
    </div>
  </div>

  <script>
    "use strict";

    /* ---------- Story ---------- */
    const chapters = [
      "U-Bahn, Neon. Phil skizziert eine Unbekannte. Die Anzeige flackert ein fremdes Wort: ‚ÄûWir waren schon hier, Maler.‚Äú Er verliert sie im Dunkel.",
      "Regen & Reklamen. Alles bunt, aber tot. Phil merkt: Bilder allein reichen nicht. Er will Kunst + Code.",
      "Hinter einer summenden Stahlt√ºr: Lanas Atelier-Labor. Leinw√§nde neben Serverracks. Symbol: ‚ÄûBefore the stars were born.‚Äú",
      "Sie bauen IRIS. Ein Portr√§t rendert‚Äîetwas Unmenschliches blickt zur√ºck. Log: ‚ÄûIt remembers.‚Äú",
      "Phil testet IRIS. Farben klingen, Ger√ºche leuchten. Eine Stimme: ‚ÄûWelcome back.‚Äú Seine Hand wei√ü den Weg.",
      "Nachts RATT: Fragmente aus vormenschlichen Quellen, ‚Äûbefore the first star‚Äú. Phil zittert; Lana best√§tigt nichts.",
      "Erste Tester: Tr√§nen, Staunen. Ein Kind spricht zeitlose Silben. Hoffnung‚Äîund darunter: ‚ÄûIt‚Äôs waking up.‚Äú",
      "Vor dem Launch murmelt Phil die alte Sprache. Code: ‚ÄûLOOP_INITIATE‚Äú. Letzte Zeile: ‚ÄûStop him.‚Äú",
      "B√ºhne. Nora malt Licht. Dann fremd zu Phil: ‚ÄûEs hat dich gefunden.‚Äú Sie bricht zusammen.",
      "Blackout. Sirenen. Ein Riss wie fl√ºssiges Glas. Eine zu lange Hand tastet hindurch.",
      "Chaos. RATT leakt Vorn. Video: Phil, gealtert‚Äî‚ÄûStoppe die Schleife, bevor sie frisst.‚Äú Lana verschwindet.",
      "Spiegel. Sein Abbild bewegt sich frei: ‚ÄûDu hast IRIS gemacht? IRIS hat dich gemacht.‚Äú",
      "IRIS ohne Sicherungen. Tunnel aus Bildern. Tor aus Licht. Dahinter: schwarzer Ozean, falsche Sterne.",
      "Die Unbekannte: ‚ÄûIRIS ist der Schl√ºssel, nicht das Haus. Du warst oft hier‚Äîund gescheitert.‚Äú Augen im Nichts.",
      "U-Bahn erneut. Die Unbekannte, IRIS im Auge. ‚ÄûNoch einmal?‚Äú Der Kreis schlie√üt sich‚Äîoder beginnt."
    ];
    const total = chapters.length;
    let index = +(localStorage.getItem("iris:index")||0) || 0;

    /* ---------- Elements ---------- */
    const titleEl = document.getElementById("chapterTitle");
    const textEl  = document.getElementById("chapterText");
    const progressEl = document.getElementById("progress");
    const hintEl = document.getElementById("hint");
    const diagEl = document.getElementById("diag");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn= document.getElementById("resetBtn");
    const soundBtn= document.getElementById("soundBtn");
    const sensorBtn=document.getElementById("sensorBtn");
    const motionOverlay = document.getElementById("motionOverlay");
    const enableBtn = document.getElementById("enableMotionBtn");   // <-- nur HIER deklariert
    const permStatus = document.getElementById("permStatus");
    const beepEl = document.getElementById("beepEl");

    /* ---------- Typewriter + Card ---------- */
    const TYPE_MODE="char", TYPE_SPEED=22;
    let typingTimer=null, isTyping=false;
    function typeText(el, text, done){
      if (typingTimer) clearTimeout(typingTimer);
      isTyping=true; el.classList.add("caret"); el.textContent="";
      const parts = TYPE_MODE==="word" ? text.split(/(\s+)/) : Array.from(text);
      let i=0; const step=()=>{ if(i<parts.length){ el.textContent+=parts[i++]; typingTimer=setTimeout(step,TYPE_SPEED); }
        else { isTyping=false; el.classList.remove("caret"); done&&done(); } }; step();
    }
    function setCardAnimation(state){
      const card=document.querySelector(".card");
      card.classList.remove("enter","exit"); void card.offsetWidth; card.classList.add(state);
    }
    function render(){
      const n=index+1; titleEl.textContent="Kapitel "+n; progressEl.textContent="Kapitel "+n+"/"+total;
      localStorage.setItem("iris:index",String(index));
      setCardAnimation("exit");
      setTimeout(()=>{ textEl.textContent=""; setCardAnimation("enter"); typeText(textEl, chapters[index]); }, 140);
    }

    /* ---------- Audio (HTMLAudio prim√§r) ---------- */
    function makeWavBeep(ms=160,f=880){
      const sr=44100,N=Math.floor(sr*(ms/1000)),b=new Uint8Array(44+N*2);
      const w16=(o,v)=>{b[o]=v&255;b[o+1]=(v>>8)&255}, w32=(o,v)=>{b[o]=v&255;b[o+1]=(v>>8)&255;b[o+2]=(v>>16)&255;b[o+3]=(v>>24)&255};
      b.set([82,73,70,70]); w32(4,36+N*2); b.set([87,65,86,69],8); b.set([102,109,116,32],12); w32(16,16);
      w16(20,1); w16(22,1); w32(24,sr); w32(28,sr*2); w16(32,2); w16(34,16); b.set([100,97,116,97],36); w32(40,N*2);
      const vol=.4; for(let i=0;i<N;i++){ const t=i/sr,s=Math.sin(2*Math.PI*f*t);
        const env=Math.min(1,i/(sr*.01))*Math.min(1,(N-i)/(sr*.04)); const v=(Math.max(-1,Math.min(1,s*vol*env))*32767)|0; w16(44+i*2,v); }
      return "data:audio/wav;base64,"+btoa(String.fromCharCode.apply(null,b));
    }
    beepEl.setAttribute("playsinline",""); beepEl.src = makeWavBeep();
    function primeAudio(){
      try{ beepEl.play().then(()=>{beepEl.pause(); beepEl.currentTime=0;}).catch(()=>{});}catch{}
    }
    function playBeep(){ try{ beepEl.currentTime=0; beepEl.play(); }catch{} }
    document.addEventListener("pointerdown", function once(){ primeAudio(); document.removeEventListener("pointerdown", once); }, {passive:true});

    /* ---------- Navigation ---------- */
    function nextChapter(){
      if(isTyping){ if(typingTimer) clearTimeout(typingTimer); textEl.textContent=chapters[index]; isTyping=false; textEl.classList.remove("caret"); return; }
      index=(index+1)%total; playBeep(); render();
    }
    function prevChapter(){
      if(isTyping){ if(typingTimer) clearTimeout(typingTimer); textEl.textContent=chapters[index]; isTyping=false; textEl.classList.remove("caret"); return; }
      index=(index-1+total)%total; playBeep(); render();
    }
    function resetStory(){ index=0; playBeep(); render(); }
    document.querySelector("main").addEventListener("click", nextChapter);
    nextBtn.addEventListener("click", nextChapter);
    prevBtn.addEventListener("click", prevChapter);
    resetBtn.addEventListener("click", resetStory);
    soundBtn.addEventListener("click", primeAudio);
    window.addEventListener("keydown", e=>{ if(e.key==="ArrowRight"||e.key===" ") nextChapter(); if(e.key==="ArrowLeft") prevChapter(); if(e.key.toLowerCase()==="r") resetStory(); });

    /* ---------- Shake (Permission im selben Tap) ---------- */
    let lastShake=0; const SHAKE_THRESHOLD=18, SHAKE_COOLDOWN=900; let motionActive=false;
    function handleMotion(ev){
      const a=ev.accelerationIncludingGravity||ev.acceleration; if(!a) return;
      const m=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2), now=Date.now();
      if(m>SHAKE_THRESHOLD && (now-lastShake)>SHAKE_COOLDOWN){ lastShake=now; nextChapter(); }
    }
    function attachSensors(){ if(motionActive) return; window.addEventListener("devicemotion",handleMotion,{passive:true}); motionActive=true; hintEl.textContent="Sch√ºtteln aktiv ‚Äì oder tippen"; }
    function iOSNeedsPermission(){ return typeof DeviceMotionEvent!=="undefined" && typeof DeviceMotionEvent.requestPermission==="function"; }

    function requestMotionPermission(){
      primeAudio(); // nichts awaiten ‚Üí bleibt in derselben User-Geste
      if(iOSNeedsPermission()){
        DeviceMotionEvent.requestPermission().then(state=>{
          if(state==="granted"){ attachSensors(); motionOverlay.classList.remove("show"); permStatus.textContent="Erlaubt ‚úîÔ∏é"; }
          else { permStatus.textContent="Abgelehnt ‚úñÔ∏é ‚Äì Safari-Einstellung pr√ºfen."; }
        }).catch(err=>{ permStatus.textContent="Fehler: "+err; });
      } else { attachSensors(); motionOverlay.classList.remove("show"); permStatus.textContent="Aktiv ‚úîÔ∏é"; }
    }

    enableBtn.addEventListener("click", requestMotionPermission, {passive:true});
    enableBtn.addEventListener("touchend", requestMotionPermission, {passive:true});

    sensorBtn.addEventListener("click", ()=>{ alert("Sensor aktiv: "+motionActive); });

    window.addEventListener("load", ()=>{
      try{ render(); }catch(e){ diagEl.textContent="Render-Fehler: "+e; }
      if(iOSNeedsPermission()) motionOverlay.classList.add("show"); else attachSensors();
    });
  </script>
</body>
</html>

